version: 1
metadata:
  name: Expression Policy - Validate password Context Attribute Complexity
context: {}
entries:
#~~~~~~~~~~~~~~~~~~~~~~~~~~~ Dependency blueprints ~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
- model: authentik_blueprints.metaapplyblueprint
  attrs:
    identifiers:
      name: Expression Policy - Validate Generic Prompt Field Data
    required: true
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Groups ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Policies ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
- model: authentik_policies_expression.expressionpolicy
  id: validate-password-context-attribute-complexity-expression-policy
  identifiers:
    name: validate-password-context-attribute-complexity-expression-policy
  attrs:
    expression:  |
      # If request.user == AnonymousUser these will be taken from the DEFAULT
      # tenant. If no default tenant is present it will fall back to the
      # defaults set in this expression policy
      USER_ATTRIBUTE_PASSWORD_REGEX = "better-blueprints/user/password-regex"
      USER_ATTRIBUTE_PASSWORD_VALIDATION_ERROR_MESSAGE = "better-blueprints/user/password-validation-error-message"

      regex = request.user.group_attributes(request.http_request).get(
              USER_ATTRIBUTE_PASSWORD_REGEX, "^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$"
      )
      err_msg = request.user.group_attributes(request.http_request).get(
          USER_ATTRIBUTE_PASSWORD_VALIDATION_ERROR_MESSAGE, None
      )

      result = ak_call_policy(
          "validate-generic-prompt-field-data-expression-policy",
          regex=regex,
          fields=("password",),
      )

      if not result.passing and err_msg:
          ak_message(err_msg)

      return result.passing
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Flows ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Prompts ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Stages ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Stage bindings ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Policy bindings ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Tenants ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
